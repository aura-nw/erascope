```markdown
# Project Overview

This folder contains a collection of services and utilities related to handling CW721 (CosmWasm) smart contracts, specifically focusing on indexing, media management, and reindexing functionalities. These services are part of a larger project aimed at tracking and managing CW721 NFTs.

## File Descriptions

### `cw721-media.service.ts`
This service is responsible for fetching metadata for CW721 tokens, downloading media files (images, animations) from IPFS or HTTP URLs, uploading them to S3, and updating the token's media information in the database. It also includes a job to filter and process tokens with unprocessed media data.

### `cw721-reindexing.service.ts`
This service handles the reindexing of CW721 contracts and their associated data. It supports two types of reindexing: full reindexing (including all historical data) and history-only reindexing for a specific contract. It also provides an action for triggering the reindexing process for multiple contracts.

### `cw721.service.ts`
This service is the main handler for CW721 contract interactions. It processes transaction events, updates token ownership, and calculates and refreshes CW721 contract statistics. It also includes a job to handle and process new transactions and another one to refresh the stats periodically. Additionally, it provides functionality to reindex missing historical data for contracts and handle block range processing.

### `cw721_handler.ts`
This file contains the `Cw721Handler` class, which encapsulates the logic for processing different types of CW721 actions (mint, burn, transfer, etc.) extracted from smart contract events. It updates token information and creates corresponding activity records.

## Usage Instructions

### `cw721-media.service.ts`
- This service runs as a background process. It is not meant to be executed directly by the user. It utilizes BullMQ for queue management and S3 for media storage.
- The `jobHandlerTokenMedia` function processes individual token media information. It is triggered by a job in the queue.
- The `jobHandlerFilter` function filters tokens with unprocessed media and adds them to the processing queue.

### `cw721-reindexing.service.ts`
- This service runs as a background process and uses BullMQ for queue management.
- Use the `reindexing` action to trigger the reindexing process for a list of contract addresses.
  ```bash
  # Example using moleculer-cli
  mol call v1.cw721ReindexingService.reindexing --contractAddresses '["contract_address_1", "contract_address_2"]' --type 'all'
  ```
   - `contractAddresses`: An array of contract addresses to reindex.
   - `type`: The type of reindexing, either 'all' or 'history'.
- The `jobHandler` function processes the reindexing job based on the given type.

### `cw721.service.ts`
- This service runs as a background process using BullMQ for queue management. It is not meant to be executed directly by the user.
- The `handleJob` function is responsible for processing new transactions involving CW721 contracts periodically. It is triggered by a job in the queue.
- The `refreshCw721Stats` function calculates and updates CW721 contract statistics. It is also triggered by a job in the queue.
- The `crawlMissingContractHistory` function is responsible for reindexing a specific range of blocks. It is triggered by another job in the queue.
- The `handleRangeBlockMissingContract` action is responsible for processing missing historical events.
  ```bash
  # Example using moleculer-cli
  mol call v1.cw721.handleRangeBlockMissingContract --smartContractId 1 --startBlock 1000 --endBlock 2000
  ```
    - `smartContractId`: The id of the smart contract.
    - `startBlock`: The start block for processing.
    - `endBlock`: The end block for processing.

### `cw721_handler.ts`
- This file defines the class `Cw721Handler`, which is used internally by `cw721.service.ts` to handle CW721 events. It is not meant to be executed directly by the user.

## Dependencies

- `@aura-nw/aurajs`: For interacting with the Aura network.
- `@cosmjs/encoding`: For encoding and decoding data.
- `@cosmjs/json-rpc`: For JSON RPC communication.
- `@ourparentcenter/moleculer-decorators-extended`: For Moleculer service decorators.
- `is-ipfs`: For IPFS URL validation.
- `moleculer`: For microservices framework.
- `file-type`: For file type detection.
- `@cosmjs/tendermint-rpc`: For Tendermint RPC communication.
- `parse-uri`: For parsing URIs.
- `axios`: For making HTTP requests.
- `aws-sdk`: For interacting with AWS S3.
- `bullmq`: For queue management.
- `lodash`: For utility functions.
- `knex`: For database interaction.

## Additional Notes

- These services rely on a configuration file (`config.json`) for various settings such as database connection, S3 bucket details, IPFS gateway addresses, timeouts, and job scheduling parameters.
- The services use a combination of database queries and external API calls to fetch and process data.
- The services are designed to be part of a larger system and should be deployed within a Moleculer microservices architecture.
- Error handling is implemented using `try...catch` blocks and logging errors for debugging purposes.
- The code uses Typescript for type safety.
- The `cw721-media.service.ts` includes logic to handle both IPFS and HTTP URLs for media files, downloading and uploading them to S3.
- The reindexing services use BullMQ queues to manage the reindexing process in a non-blocking and reliable manner.
- The `cw721_handler.ts` file provides a centralized way to handle different CW721 actions, making the code more maintainable.
