```markdown
# CW20 Services

## Introduction

This folder contains a set of services related to handling CW20 tokens within the application. It includes services for indexing, updating, and reindexing CW20 token data based on smart contract events. These services use BullMQ for job queue management and interact with a database via Knex.js.

## File Descriptions

- **`cw20.service.ts`**: This service is responsible for processing CW20 contract events, including instantiation, minting, burning, and transfers. It fetches relevant events from the database, updates CW20 contract information and holder balances, and manages the job queue for processing these events. It also calculates statistics about total holders each day.
- **`cw20_reindexing.service.ts`**: This service provides functionality to reindex all data related to a specific CW20 contract. It handles the removal of existing data (activities, holders) before re-crawling the contract's history from scratch by creating related jobs `REINDEX_CW20_HISTORY` and `CW20_UPDATE_BY_CONTRACT`.
- **`cw20_update_by_contract.service.ts`**: This service updates the balance of CW20 token holders based on new transfer events detected in `Cw20Activity`. It processes changes in holder balances due to minting, burning or transferring tokens between addresses within a given block range and update total supply for each cw20 contract.

## Usage Instructions

### `cw20.service.ts`
- **Execution:** This service runs as part of the application's background task system using Moleculer's service framework and BullMQ for queue management , it does not have CLI usage..
- The main logic is triggered by the `HANDLE_CW20` job which is configured to run periodically by config file in `config/cw20/millisecondRepeatJob`.
  - The service will call other services like `Cw20UpdateByContractService` when need to update balance of holders base on new transaction detected in current crawl blocks range .
  - The service also call method get Cw20 statistic everyday (total holder) .
-   **Configuration:** Configuration parameters such as repeat time are set via config file in `/config/cw20/`.

### `cw20_reindexing.service.ts`
-   **Execution:** This service provides an action called `Reindexing`, that can be called through Moleculer's API with parameters: `{ contractAddress: string }`.  It does not have CLI usage..
    After that it creates 1 job named `REINDEX_CW20_CONTRACT`, this job will remove all old data related to this cw20 contract then reinsert them again .  It also creates 1 more job named `REINDEX_CW20_HISTORY`, which will handle insert all cw2o activities into db after that calls  job name `CW2O_UPDATE_BY_CONTRACT` when need update balance of holders base on new transaction detected in current crawl blocks range .
    * All jobs are managed by BullMQ queue manager .

### `cw20_update_by_contract.service.ts`
-   **Execution:** This service runs as part of the application's background task system using Moleculer's service framework and BullMQ for queue management , it does not have CLI usage.. Its main purpose is updating balance of holders base on new transaction detected in current crawl blocks range . The main logic is triggered by other services such as :  `Cw2OReindexingContract`, or  `Cw2OContract`.
 - Configuration parameters such as retry attempts are set via config file in `/config/jobRetryAttempt/`.

## Dependencies

-   **@ourparentcenter/moleculer-decorators-extended**: For Moleculer service decorators extending capabilities such as Action decorator..
-   **bullmq**: For managing job queues using Redis (or other supported backends).
-   **knex**: For database interaction.
-   **lodash**: For utility functions (e.g., array manipulation).
-   **moleculer**: Core framework for microservices.
- **config.json**: Configuration file containing settings for the services and BullMQ job repeat time.

## Additional Notes

-   The `cw20.service.ts` uses a checkpoint mechanism (`BlockCheckpoint`) to track processing progress and ensure no events are missed or processed twice..
-   The services rely on smart contract event data fetched from the database, which should be correctly populated by other application components..
-   Error handling and logging are done using Moleculer's built in features..
-  The reindexing service is designed to handle cases where the historical data needs to be reprocessed due to changes in business logic or data migration purposes..
```